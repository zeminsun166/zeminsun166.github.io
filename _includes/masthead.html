<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <button><div class="navicon"></div></button>
        <ul class="visible-links" id="navigation-links">
          <!-- å¯¼èˆªé“¾æ¥å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </ul>
        <ul class="hidden-links hidden">
          <!-- ç§»åŠ¨ç«¯å¯¼èˆªé“¾æ¥å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          <li class="language-switcher">
            <button id="lang-toggle" class="lang-toggle-btn" title="åˆ‡æ¢è¯­è¨€/Switch Language">
              <span class="lang-text-mobile" data-show-when="zh">English</span>
              <span class="lang-text-mobile" data-show-when="en">ä¸­æ–‡</span>
            </button>
          </li>
        </ul>
      </nav>
    </div>
    <!-- æ¡Œé¢ç«¯ç‹¬ç«‹çš„è¯­è¨€åˆ‡æ¢å™¨ -->
    <div class="language-switcher language-switcher--desktop">
      <button id="lang-toggle-desktop" class="lang-toggle-btn" title="åˆ‡æ¢è¯­è¨€/Switch Language">
        ğŸŒ
      </button>
    </div>
  </div>
</div>

<script>
// å¯¼èˆªæ•°æ®
const navigationData = {
  zh: [
    { title: "ä¸»é¡µ", section: "about-me" },
    { title: "æ•™è‚²ç»å†", section: "educations" },
    { title: "å­¦æœ¯è®ºæ–‡", section: "publications" },
    { title: "é¡¹ç›®ç»å†", section: "projects" },
    { title: "ä¸“åˆ©", section: "patents" },
    { title: "å­¦æœ¯æœåŠ¡", section: "services" },
    { title: "è·å¥–æƒ…å†µ", section: "awards" }
  ],
  en: [
    { title: "Homepage", section: "about-me" },
    { title: "Education", section: "educations" },
    { title: "Publications", section: "publications" },
    { title: "Projects", section: "projects" },
    { title: "Patents", section: "patents" },
    { title: "Services", section: "services" },
    { title: "Awards", section: "awards" }
  ]
};

// è·å–å½“å‰è¯­è¨€
function getCurrentLanguage() {
  const currentPath = window.location.pathname;
  return (currentPath.includes('/en/')) ? 'en' : 'zh';
}

// ç”Ÿæˆå¯¼èˆªé“¾æ¥
function generateNavigationLinks() {
  const currentLang = getCurrentLanguage();
  const navData = navigationData[currentLang];
  const navContainer = document.getElementById('navigation-links');
  if (!navContainer || !navData) return;
  
  // æ¸…ç©ºç°æœ‰é“¾æ¥
  navContainer.innerHTML = '';
  
  // ç”Ÿæˆæ¡Œé¢ç«¯å¯¼èˆªé“¾æ¥
  navData.forEach((item, index) => {
    const li = document.createElement('li');
    const a = document.createElement('a');
    
    // è®¾ç½®é“¾æ¥å±æ€§ - ä½¿ç”¨ç›¸å¯¹é”šç‚¹é“¾æ¥
    a.href = `#${item.section}`;
    a.textContent = item.title;
    a.className = 'nav-link';
    a.dataset.section = item.section;
    
    // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†é”šç‚¹è·³è½¬
    a.addEventListener('click', function(e) {
      e.preventDefault();
      
      console.log('=== Navigation Click Debug ===');
      console.log('Current URL:', window.location.href);
      console.log('Current pathname:', window.location.pathname);
      console.log('Clicking on:', item.title, 'section:', item.section);
      
      // å°è¯•å¤šç§æ–¹å¼æŸ¥æ‰¾ç›®æ ‡å…ƒç´ 
      let targetSection = document.getElementById(item.section);
      
      // å¦‚æœç›´æ¥æŸ¥æ‰¾å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•
      if (!targetSection) {
        console.log('Direct ID lookup failed, trying alternative methods...');
        
        // æ–¹æ³•1ï¼šæŸ¥æ‰¾åŒ…å«ç‰¹å®šæ–‡æœ¬çš„æ ‡é¢˜å…ƒç´ 
        const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
        console.log('Found headings:', headings.length);
        
        for (let heading of headings) {
          console.log('Checking heading:', heading.textContent.trim(), 'ID:', heading.id);
          if (heading.textContent.includes(item.title) || heading.id === item.section) {
            targetSection = heading;
            console.log('Found target heading:', heading);
            break;
          }
        }
        
        // æ–¹æ³•2ï¼šæŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„é”šç‚¹
        if (!targetSection) {
          console.log('Heading search failed, trying anchor search...');
          const allAnchors = document.querySelectorAll('[id]');
          console.log('All elements with ID:', allAnchors.length);
          
          for (let anchor of allAnchors) {
            console.log('Anchor ID:', anchor.id, 'Tag:', anchor.tagName, 'Text:', anchor.textContent.substring(0, 50));
            if (anchor.id === item.section || anchor.id.includes(item.section)) {
              targetSection = anchor;
              console.log('Found target anchor:', anchor);
              break;
            }
          }
        }
        
        // æ–¹æ³•3ï¼šæŸ¥æ‰¾åŒ…å«sectionåç§°çš„spanæˆ–å…¶ä»–å…ƒç´ 
        if (!targetSection) {
          console.log('Anchor search failed, trying span search...');
          const spans = document.querySelectorAll('span[id]');
          for (let span of spans) {
            if (span.id === item.section) {
              targetSection = span;
              console.log('Found target span:', span);
              break;
            }
          }
        }
      }
      
      console.log('Final target element found:', targetSection);
      
      if (targetSection) {
        // ç¡®ä¿å…ƒç´ å¯è§
        targetSection.style.scrollMarginTop = '100px'; // ä¸ºå›ºå®šå¯¼èˆªæ ç•™å‡ºç©ºé—´
        targetSection.scrollIntoView({ behavior: 'smooth' });
        console.log('Successfully scrolled to section:', item.section);
      } else {
        console.log('All search methods failed for section:', item.section);
        // å°è¯•æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„é”šç‚¹
        const allAnchors = document.querySelectorAll('[id]');
        console.log('All available anchors:', Array.from(allAnchors).map(el => ({id: el.id, tag: el.tagName, text: el.textContent.substring(0, 30)})));
        
        // å¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œå°è¯•ä½¿ç”¨æµè§ˆå™¨é»˜è®¤çš„é”šç‚¹è·³è½¬
        console.log('Falling back to default anchor behavior');
        window.location.hash = item.section;
      }
      
      console.log('=== End Debug ===');
    });
    
    // ç¬¬ä¸€ä¸ªé“¾æ¥æ˜¯ä¸»é¡µï¼Œéœ€è¦ç‰¹æ®Šæ ·å¼
    if (index === 0) {
      li.className = 'masthead__menu-item masthead__menu-item--lg masthead__menu-home-item';
    } else {
      li.className = 'masthead__menu-item';
    }
    
    li.appendChild(a);
    navContainer.appendChild(li);
  });

  // ç”Ÿæˆç§»åŠ¨ç«¯å¯¼èˆªé“¾æ¥
  const mobileNavContainer = document.querySelector('.hidden-links');
  if (mobileNavContainer) {
    console.log('=== Mobile Navigation Generation Debug ===');
    console.log('Before cleanup - Total items:', mobileNavContainer.children.length);
    console.log('Before cleanup - Navigation items:', mobileNavContainer.querySelectorAll('li:not(.language-switcher)').length);
    
    // é¦–å…ˆæ¸…ç†æ‰€æœ‰ç°æœ‰çš„å¯¼èˆªé“¾æ¥ï¼ˆä¿ç•™è¯­è¨€åˆ‡æ¢å™¨ï¼‰
    const languageSwitcher = mobileNavContainer.querySelector('.language-switcher');
    const allNavItems = mobileNavContainer.querySelectorAll('li:not(.language-switcher)');
    
    console.log('Found language switcher:', !!languageSwitcher);
    console.log('Found navigation items to remove:', allNavItems.length);
    
    // ç§»é™¤æ‰€æœ‰æ—§çš„å¯¼èˆªé¡¹
    allNavItems.forEach((item, index) => {
      console.log(`Removing item ${index}:`, item.textContent.trim());
      item.remove();
    });
    
    console.log('After cleanup - Total items:', mobileNavContainer.children.length);
    console.log('After cleanup - Navigation items:', mobileNavContainer.querySelectorAll('li:not(.language-switcher)').length);
    
    // é‡æ–°åˆ›å»ºå¯¼èˆªé¡¹
    navData.forEach((item, index) => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      
      // è®¾ç½®é“¾æ¥å±æ€§ - ä½¿ç”¨ç›¸å¯¹é”šç‚¹é“¾æ¥
      a.href = `#${item.section}`;
      a.textContent = item.title;
      a.className = 'nav-link-mobile';
      a.dataset.section = item.section;
      
      // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†é”šç‚¹è·³è½¬
      a.addEventListener('click', function(e) {
        e.preventDefault();
        
        console.log('=== Mobile Navigation Click Debug ===');
        console.log('Current URL:', window.location.href);
        console.log('Current pathname:', window.location.pathname);
        console.log('Mobile: Clicking on:', item.title, 'section:', item.section);
        
        // å°è¯•å¤šç§æ–¹å¼æŸ¥æ‰¾ç›®æ ‡å…ƒç´ 
        let targetSection = document.getElementById(item.section);
        
        // å¦‚æœç›´æ¥æŸ¥æ‰¾å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•
        if (!targetSection) {
          console.log('Mobile: Direct ID lookup failed, trying alternative methods...');
          
          // æ–¹æ³•1ï¼šæŸ¥æ‰¾åŒ…å«ç‰¹å®šæ–‡æœ¬çš„æ ‡é¢˜å…ƒç´ 
          const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
          console.log('Mobile: Found headings:', headings.length);
          
          for (let heading of headings) {
            console.log('Mobile: Checking heading:', heading.textContent.trim(), 'ID:', heading.id);
            if (heading.textContent.includes(item.title) || heading.id === item.section) {
              targetSection = heading;
              console.log('Mobile: Found target heading:', heading);
              break;
            }
          }
          
          // æ–¹æ³•2ï¼šæŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„é”šç‚¹
          if (!targetSection) {
            console.log('Mobile: Heading search failed, trying anchor search...');
            const allAnchors = document.querySelectorAll('[id]');
            console.log('Mobile: All elements with ID:', allAnchors.length);
            
            for (let anchor of allAnchors) {
              console.log('Mobile: Anchor ID:', anchor.id, 'Tag:', anchor.tagName, 'Text:', anchor.textContent.substring(0, 50));
              if (anchor.id === item.section || anchor.id.includes(item.section)) {
                targetSection = anchor;
                console.log('Mobile: Found target anchor:', anchor);
                break;
              }
            }
          }
          
          // æ–¹æ³•3ï¼šæŸ¥æ‰¾åŒ…å«sectionåç§°çš„spanæˆ–å…¶ä»–å…ƒç´ 
          if (!targetSection) {
            console.log('Mobile: Anchor search failed, trying span search...');
            const spans = document.querySelectorAll('span[id]');
            for (let span of spans) {
              if (span.id === item.section) {
                targetSection = span;
                console.log('Mobile: Found target span:', span);
                break;
              }
            }
          }
        }
        
        console.log('Mobile: Final target element found:', targetSection);
        
        if (targetSection) {
          // ç¡®ä¿å…ƒç´ å¯è§
          targetSection.style.scrollMarginTop = '100px'; // ä¸ºå›ºå®šå¯¼èˆªæ ç•™å‡ºç©ºé—´
          targetSection.scrollIntoView({ behavior: 'smooth' });
          console.log('Mobile: Successfully scrolled to section:', item.section);
        } else {
          console.log('Mobile: All search methods failed for section:', item.section);
          // å°è¯•æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„é”šç‚¹
          const allAnchors = document.querySelectorAll('[id]');
          console.log('Mobile: All available anchors:', Array.from(allAnchors).map(el => ({id: el.id, tag: el.tagName, text: el.textContent.substring(0, 30)})));
          
          // å¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œå°è¯•ä½¿ç”¨æµè§ˆå™¨é»˜è®¤çš„é”šç‚¹è·³è½¬
          console.log('Mobile: Falling back to default anchor behavior');
          window.location.hash = item.section;
        }
        
        console.log('=== Mobile End Debug ===');
      });
      
      li.appendChild(a);
      mobileNavContainer.appendChild(li);
      console.log(`Added item ${index}:`, item.title);
    });
    
    // ç¡®ä¿è¯­è¨€åˆ‡æ¢å™¨åœ¨æœ€å
    if (languageSwitcher) {
      mobileNavContainer.appendChild(languageSwitcher);
      console.log('Added language switcher at the end');
    }
    
    console.log('After creation - Total items:', mobileNavContainer.children.length);
    console.log('After creation - Navigation items:', mobileNavContainer.querySelectorAll('li:not(.language-switcher)').length);
    console.log('Final navigation order:', Array.from(mobileNavContainer.querySelectorAll('li:not(.language-switcher)')).map(li => li.textContent.trim()));
    console.log('=== Mobile Navigation Generation End ===');
    
    // é‡æ–°è§¦å‘greedy navigationæ’ä»¶çš„æ›´æ–°
    if (typeof updateNav === 'function') {
      // é‡ç½®æ’ä»¶çš„çŠ¶æ€ï¼Œé˜²æ­¢è‡ªåŠ¨æ·»åŠ é‡å¤é¡¹
      if (window.breaks && Array.isArray(window.breaks)) {
        window.breaks.length = 0;
      }
      updateNav();
    }
    
    // å¼ºåˆ¶é‡æ–°è®¡ç®—å¸ƒå±€ï¼Œç¡®ä¿æŠ˜å æ¡†ç«‹å³æ˜¾ç¤º
    setTimeout(() => {
      if (typeof updateNav === 'function') {
        // å†æ¬¡é‡ç½®çŠ¶æ€
        if (window.breaks && Array.isArray(window.breaks)) {
          window.breaks.length = 0;
        }
        updateNav();
      }
      // è§¦å‘çª—å£resizeäº‹ä»¶ï¼Œç¡®ä¿greedy navigationæ’ä»¶é‡æ–°è®¡ç®—
      window.dispatchEvent(new Event('resize'));
      
      // å†æ¬¡æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤é¡¹
      setTimeout(() => {
        const finalNavItems = mobileNavContainer.querySelectorAll('li:not(.language-switcher)');
        console.log('Final check - Navigation items:', finalNavItems.length);
        console.log('Final check - Navigation order:', Array.from(finalNavItems).map(li => li.textContent.trim()));
        
        // æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤
        const titles = Array.from(finalNavItems).map(li => li.textContent.trim());
        const uniqueTitles = [...new Set(titles)];
        if (titles.length !== uniqueTitles.length) {
          console.warn('WARNING: Duplicate navigation items detected!');
          console.warn('Original titles:', titles);
          console.warn('Unique titles:', uniqueTitles);
          
          // å¦‚æœå‘ç°é‡å¤ï¼Œå¼ºåˆ¶æ¸…ç†å¹¶é‡æ–°ç”Ÿæˆ
          console.log('Forcing cleanup of duplicate items...');
          const allNavItems = mobileNavContainer.querySelectorAll('li:not(.language-switcher)');
          const languageSwitcher = mobileNavContainer.querySelector('.language-switcher');
          
          // ç§»é™¤æ‰€æœ‰å¯¼èˆªé¡¹
          allNavItems.forEach(item => item.remove());
          
          // é‡æ–°åˆ›å»ºå¯¼èˆªé¡¹
          navData.forEach((item) => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            
            a.href = `#${item.section}`;
            a.textContent = item.title;
            a.className = 'nav-link-mobile';
            a.dataset.section = item.section;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†
            a.addEventListener('click', function(e) {
              e.preventDefault();
              const targetSection = document.getElementById(item.section);
              if (targetSection) {
                targetSection.style.scrollMarginTop = '100px';
                targetSection.scrollIntoView({ behavior: 'smooth' });
              }
            });
            
            li.appendChild(a);
            mobileNavContainer.appendChild(li);
          });
          
          // ç¡®ä¿è¯­è¨€åˆ‡æ¢å™¨åœ¨æœ€å
          if (languageSwitcher) {
            mobileNavContainer.appendChild(languageSwitcher);
          }
          
          console.log('Forced cleanup completed');
        }
      }, 100);
    }, 50);
  }
}

// æ›´æ–°å¯¼èˆªé“¾æ¥
function updateNavigationLinks() {
  generateNavigationLinks();
}

// é¡µé¢åŠ è½½å®Œæˆåç”Ÿæˆå¯¼èˆªé“¾æ¥
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(() => {
    generateNavigationLinks();
  }, 100);
});

// ç¡®ä¿åœ¨é¡µé¢å®Œå…¨åŠ è½½åå†æ¬¡æ£€æŸ¥
window.addEventListener('load', function() {
  setTimeout(() => {
    generateNavigationLinks();
  }, 200);
});

// ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œç¡®ä¿åœ¨é¡µé¢åˆ‡æ¢æ—¶é‡æ–°åˆå§‹åŒ–
document.addEventListener('visibilitychange', function() {
  if (!document.hidden) {
    setTimeout(() => {
      generateNavigationLinks();
    }, 100);
  }
});

// è¯­è¨€åˆ‡æ¢åæ›´æ–°å¯¼èˆªé“¾æ¥
document.addEventListener('languageChanged', function() {
  generateNavigationLinks();
  
  // ç¡®ä¿åœ¨è¯­è¨€åˆ‡æ¢åç«‹å³æ˜¾ç¤ºæŠ˜å æ¡†
  setTimeout(() => {
    if (typeof updateNav === 'function') {
      updateNav();
    }
    // è§¦å‘çª—å£resizeäº‹ä»¶ï¼Œç¡®ä¿greedy navigationæ’ä»¶é‡æ–°è®¡ç®—
    window.dispatchEvent(new Event('resize'));
  }, 100);
});
</script>