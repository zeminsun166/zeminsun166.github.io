<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <button><div class="navicon"></div></button>
        <ul class="visible-links" id="navigation-links">
          <!-- 导航链接将通过JavaScript动态生成 -->
        </ul>
        <ul class="hidden-links hidden">
          <!-- 移动端导航链接将通过JavaScript动态生成 -->
          <li class="language-switcher">
            <button id="lang-toggle" class="lang-toggle-btn" title="切换语言/Switch Language">
              <span class="lang-text-mobile" data-show-when="zh">English</span>
              <span class="lang-text-mobile" data-show-when="en">中文</span>
            </button>
          </li>
        </ul>
      </nav>
    </div>
    <!-- 桌面端独立的语言切换器 -->
    <div class="language-switcher language-switcher--desktop">
      <button id="lang-toggle-desktop" class="lang-toggle-btn" title="切换语言/Switch Language">
        🌐
      </button>
    </div>
  </div>
</div>

<script>
// 导航数据
const navigationData = {
  zh: [
    { title: "主页", section: "about-me" },
    { title: "教育经历", section: "educations" },
    { title: "学术论文", section: "publications" },
    { title: "项目经历", section: "projects" },
    { title: "专利", section: "patents" },
    { title: "学术服务", section: "services" },
    { title: "获奖情况", section: "awards" }
  ],
  en: [
    { title: "Homepage", section: "about-me" },
    { title: "Education", section: "educations" },
    { title: "Publications", section: "publications" },
    { title: "Projects", section: "projects" },
    { title: "Patents", section: "patents" },
    { title: "Services", section: "services" },
    { title: "Awards", section: "awards" }
  ]
};

// 获取当前语言
function getCurrentLanguage() {
  const currentPath = window.location.pathname;
  return (currentPath.includes('/en/')) ? 'en' : 'zh';
}

// 生成导航链接
function generateNavigationLinks() {
  const currentLang = getCurrentLanguage();
  const navData = navigationData[currentLang];
  const navContainer = document.getElementById('navigation-links');
  if (!navContainer || !navData) return;
  
  // 清空现有链接
  navContainer.innerHTML = '';
  
  // 生成桌面端导航链接
  navData.forEach((item, index) => {
    const li = document.createElement('li');
    const a = document.createElement('a');
    
    // 设置链接属性 - 使用相对锚点链接
    a.href = `#${item.section}`;
    a.textContent = item.title;
    a.className = 'nav-link';
    a.dataset.section = item.section;
    
    // 添加点击事件处理锚点跳转
    a.addEventListener('click', function(e) {
      e.preventDefault();
      
      console.log('=== Navigation Click Debug ===');
      console.log('Current URL:', window.location.href);
      console.log('Current pathname:', window.location.pathname);
      console.log('Clicking on:', item.title, 'section:', item.section);
      
      // 尝试多种方式查找目标元素
      let targetSection = document.getElementById(item.section);
      
      // 如果直接查找失败，尝试其他方法
      if (!targetSection) {
        console.log('Direct ID lookup failed, trying alternative methods...');
        
        // 方法1：查找包含特定文本的标题元素
        const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
        console.log('Found headings:', headings.length);
        
        for (let heading of headings) {
          console.log('Checking heading:', heading.textContent.trim(), 'ID:', heading.id);
          if (heading.textContent.includes(item.title) || heading.id === item.section) {
            targetSection = heading;
            console.log('Found target heading:', heading);
            break;
          }
        }
        
        // 方法2：查找所有可能的锚点
        if (!targetSection) {
          console.log('Heading search failed, trying anchor search...');
          const allAnchors = document.querySelectorAll('[id]');
          console.log('All elements with ID:', allAnchors.length);
          
          for (let anchor of allAnchors) {
            console.log('Anchor ID:', anchor.id, 'Tag:', anchor.tagName, 'Text:', anchor.textContent.substring(0, 50));
            if (anchor.id === item.section || anchor.id.includes(item.section)) {
              targetSection = anchor;
              console.log('Found target anchor:', anchor);
              break;
            }
          }
        }
        
        // 方法3：查找包含section名称的span或其他元素
        if (!targetSection) {
          console.log('Anchor search failed, trying span search...');
          const spans = document.querySelectorAll('span[id]');
          for (let span of spans) {
            if (span.id === item.section) {
              targetSection = span;
              console.log('Found target span:', span);
              break;
            }
          }
        }
      }
      
      console.log('Final target element found:', targetSection);
      
      if (targetSection) {
        // 确保元素可见
        targetSection.style.scrollMarginTop = '100px'; // 为固定导航栏留出空间
        targetSection.scrollIntoView({ behavior: 'smooth' });
        console.log('Successfully scrolled to section:', item.section);
      } else {
        console.log('All search methods failed for section:', item.section);
        // 尝试查找所有可能的锚点
        const allAnchors = document.querySelectorAll('[id]');
        console.log('All available anchors:', Array.from(allAnchors).map(el => ({id: el.id, tag: el.tagName, text: el.textContent.substring(0, 30)})));
        
        // 如果还是找不到，尝试使用浏览器默认的锚点跳转
        console.log('Falling back to default anchor behavior');
        window.location.hash = item.section;
      }
      
      console.log('=== End Debug ===');
    });
    
    // 第一个链接是主页，需要特殊样式
    if (index === 0) {
      li.className = 'masthead__menu-item masthead__menu-item--lg masthead__menu-home-item';
    } else {
      li.className = 'masthead__menu-item';
    }
    
    li.appendChild(a);
    navContainer.appendChild(li);
  });
  
  // 移动端导航处理
  const mobileNavContainer = document.querySelector('ul.hidden-links');
  if (mobileNavContainer) {
    console.log('=== Mobile Navigation Debug ===');
    
    // 首先，移除所有现有的导航 li 元素（除了语言切换器）
    const existingNavItems = mobileNavContainer.querySelectorAll('li:not(.language-switcher)');
    console.log('Removing existing navigation items:', existingNavItems.length);
    existingNavItems.forEach(item => item.remove());
    
    // 然后，重新创建导航 li 元素
    console.log('Creating new navigation items for:', navData.length, 'items');
    navData.forEach((item, index) => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      
      a.href = `#${item.section}`;
      a.textContent = item.title;
      a.className = 'nav-link-mobile';
      a.dataset.section = item.section;
      
      // 添加点击事件处理
      a.addEventListener('click', function(e) {
        e.preventDefault();
        const targetSection = document.getElementById(item.section);
        if (targetSection) {
          targetSection.style.scrollMarginTop = '100px';
          targetSection.scrollIntoView({ behavior: 'smooth' });
        }
      });
      
      li.appendChild(a);
      mobileNavContainer.appendChild(li);
      console.log('Added mobile nav item:', item.title);
    });
    
    // 确保语言切换器在最后
    const languageSwitcher = mobileNavContainer.querySelector('.language-switcher');
    if (languageSwitcher) {
      mobileNavContainer.appendChild(languageSwitcher);
      console.log('Moved language switcher to end');
    }
    
    // 让greedy navigation插件正常工作，不要强制重置状态
    if (typeof updateNav === 'function') {
      console.log('Calling updateNav() to let greedy navigation work normally');
      
      // 不要阻止插件的正常工作，让它根据屏幕宽度来决定折叠
      // 但是要确保我们的导航项在visible-links中，这样插件才能正确计算
      const visibleLinks = document.querySelector('ul.visible-links');
      if (visibleLinks) {
        // 确保visible-links包含我们的导航项，这样插件才能正确计算哪些需要折叠
        visibleLinks.innerHTML = '';
        navData.forEach((item, index) => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          
          a.href = `#${item.section}`;
          a.textContent = item.title;
          a.className = 'nav-link';
          a.dataset.section = item.section;
          
          // 添加点击事件处理锚点跳转
          a.addEventListener('click', function(e) {
            e.preventDefault();
            const targetSection = document.getElementById(item.section);
            if (targetSection) {
              targetSection.style.scrollMarginTop = '100px';
              targetSection.scrollIntoView({ behavior: 'smooth' });
            }
          });
          
          li.appendChild(a);
          visibleLinks.appendChild(li);
        });
        
        // 现在调用updateNav，让插件根据屏幕宽度决定哪些项目需要折叠
        updateNav();
        
        // 确保语言切换器在hidden-links的最后
        const languageSwitcher = mobileNavContainer.querySelector('.language-switcher');
        if (languageSwitcher) {
          // 如果语言切换器不在hidden-links中，移动它
          if (!mobileNavContainer.contains(languageSwitcher)) {
            mobileNavContainer.appendChild(languageSwitcher);
          }
        }
      } else {
        updateNav();
      }
    }
    
    // 检查最终结果
    setTimeout(() => {
      const finalNavItems = mobileNavContainer.querySelectorAll('li:not(.language-switcher)');
      console.log('Final check - Navigation items:', finalNavItems.length);
      console.log('Final check - Navigation order:', Array.from(finalNavItems).map(li => li.textContent.trim()));
      
      // 检查是否有重复
      const titles = Array.from(finalNavItems).map(li => li.textContent.trim());
      const uniqueTitles = [...new Set(titles)];
      if (titles.length !== uniqueTitles.length) {
        console.warn('WARNING: Duplicate navigation items detected!');
        console.warn('Original titles:', titles);
        console.warn('Unique titles:', uniqueTitles);
        
        // 如果发现重复，强制清理并重新生成
        console.log('Forcing cleanup of duplicate items...');
        const allNavItems = mobileNavContainer.querySelectorAll('li:not(.language-switcher)');
        const languageSwitcher = mobileNavContainer.querySelector('.language-switcher');
        
        // 移除所有导航项
        allNavItems.forEach(item => item.remove());
        
        // 重新创建导航项
        navData.forEach((item) => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          
          a.href = `#${item.section}`;
          a.textContent = item.title;
          a.className = 'nav-link-mobile';
          a.dataset.section = item.section;
          
          // 添加点击事件处理
          a.addEventListener('click', function(e) {
            e.preventDefault();
            const targetSection = document.getElementById(item.section);
            if (targetSection) {
              targetSection.style.scrollMarginTop = '100px';
              targetSection.scrollIntoView({ behavior: 'smooth' });
            }
          });
          
          li.appendChild(a);
          mobileNavContainer.appendChild(li);
        });
        
        // 确保语言切换器在最后
        if (languageSwitcher) {
          mobileNavContainer.appendChild(languageSwitcher);
        }
        
        console.log('Forced cleanup completed');
        
        // 清理完成后，再次调用updateNav让插件正常工作
        if (typeof updateNav === 'function') {
          updateNav();
        }
      }
    }, 100);
  }
}

// 更新导航链接
function updateNavigationLinks() {
  generateNavigationLinks();
}

// 页面加载完成后生成导航链接
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(() => {
    generateNavigationLinks();
  }, 100);
});

// 确保在页面完全加载后再次检查
window.addEventListener('load', function() {
  setTimeout(() => {
    generateNavigationLinks();
  }, 200);
});

// 监听页面可见性变化，确保在页面切换时重新初始化
document.addEventListener('visibilitychange', function() {
  if (!document.hidden) {
    setTimeout(() => {
      generateNavigationLinks();
    }, 100);
  }
});

// 语言切换后更新导航链接
document.addEventListener('languageChanged', function() {
  generateNavigationLinks();
  
  // 确保在语言切换后立即显示折叠框
  setTimeout(() => {
    if (typeof updateNav === 'function') {
      updateNav();
    }
    // 触发窗口resize事件，确保greedy navigation插件重新计算
    window.dispatchEvent(new Event('resize'));
  }, 100);
});
</script>